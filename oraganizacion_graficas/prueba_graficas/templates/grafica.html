{% extends "base.html" %}

{% block title %}{{ titulo }}{% endblock %}
{% block header_title %}{{ titulo }}{% endblock %}

{% block content %}
  <div id="grafica-container" style="width:100%;">
    <div id="graph"></div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  const nodoId = "{{ nodo_id }}";
  const variable = "{{ variable }}";

  // OpenWeather trace precargado desde backend (si existe)
  const openweatherTrace = {{ openweather_trace | tojson | safe }};

  function cargarYActualizarGrafica() {
  fetch(`/api/datos_grafica/${nodoId}/${variable}`)
    .then(res => res.json())
    .then(data => {
      if (!data.timestamps || data.timestamps.length === 0) {
        console.warn("‚ö†Ô∏è No hay datos para graficar");
        return;
      }

      const sensorTrace = {
        x: data.timestamps,
        y: data.valores,
        type: 'scatter',
        mode: 'lines+markers',
        name: variable,
        line: { shape: 'linear', color: 'blue' }
      };

      const rangoMin = data.timestamps[0];
      const rangoMax = data.timestamps[data.timestamps.length - 1];

      const layout = {
        title: `${variable.charAt(0).toUpperCase() + variable.slice(1)} - ${nodoId}`,
        xaxis: {
          title: 'Hora del d√≠a',
          range: [rangoMin, rangoMax]  // üëà CENTRA en los datos del sensor
        },
        yaxis: { title: variable },
        margin: { l: 50, r: 20, t: 50, b: 50 },
        legend: { x: 0.01, y: 0.99, bgcolor: 'rgba(255,255,255,0.8)' }
      };

      const traces = [sensorTrace];
      if (openweatherTrace) {
        traces.push(openweatherTrace);
      }

      Plotly.react('graph', traces, layout);
      console.log("‚úÖ Gr√°fica del sensor actualizada");
    })
    .catch(err => console.error("‚ùå Error al actualizar sensor:", err));
}


  cargarYActualizarGrafica();
  setInterval(cargarYActualizarGrafica, 5000);
</script>
{% endblock %}
